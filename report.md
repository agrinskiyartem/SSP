# Отчёт по курсовой работе «Банкоматы» (вариант №36)

## 1. Введение и постановка задачи

Цель курсовой работы — разработать web-прототип информационной системы для учёта и анализа операций снятия наличных в банкоматах. Проект реализован на PHP + MySQL и предназначен для демонстрации предметной области «Банкоматы» (вариант №36), включая справочники банков и банкоматов, клиентов и карт, операции снятия, а также аналитические отчёты. Основные требования: поддержка комиссионных правил, разграничение ролей, работа через формы веб-интерфейса и обеспечение целостности данных при конкурентном доступе.

## 2. Описание предметной области и бизнес-правила

**Предметная область:** банки обслуживают банкоматы и клиентов, выпускают банковские карты. Клиенты могут снимать наличные в любое время в любом банкомате. Система фиксирует операции снятия и позволяет анализировать частоту использования банкоматов, комиссионные вознаграждения и динамику операций.

**Бизнес-правило комиссий:**
- если банк-эмитент карты совпадает с банком-владельцем банкомата, комиссия = **0%**;
- если банки разные, комиссия = **1.2%** от суммы снятия.

Комиссия применяется к операции снятия и влияет на итоговую сумму списания `total_debit = amount + commission_amount`.

## 3. Модели/диаграммы

### 3.1 ER-диаграмма (концептуальная модель, кардинальности)
```
Bank (1) --- (N) ATM
Bank (1) --- (N) Customer
Bank (1) --- (N) Card
Customer (1) --- (N) Account
Account (1) --- (N) Card
ATM (1) --- (N) Withdrawal
Card (1) --- (N) Withdrawal
Account (1) --- (N) Withdrawal
```

**Сущности и атрибуты (кратко):**
- Bank: bank_id, name
- ATM: atm_id, bank_id, location, status
- Customer: customer_id, bank_id, full_name
- Account: account_id, customer_id, balance, currency, status
- Card: card_id, account_id, issuing_bank_id, pan_last4, exp_date, status
- Withdrawal: withdrawal_id, atm_id, card_id, account_id, amount, commission_amount, total_debit, created_at

### 3.2 Функциональная модель (Use-case)
```
Актор: Клиент
  - Снятие наличных
    - включает: Проверка баланса
    - включает: Расчёт комиссии
    - включает: Регистрация операции

Актор: Банк (администратор/аналитик)
  - Аналитика операций
  - Просмотр/учёт операций
```

### 3.3 Алгоритм «Снятие наличных» (activity, текст)
1. Клиент выбирает карту и вводит сумму.
2. Система определяет банк-эмитент карты и банк-владельца банкомата.
3. Рассчитывается комиссия (0% или 1.2%).
4. Начинается транзакция.
5. Выполняется `SELECT ... FOR UPDATE` для блокировки строки счёта.
6. Проверка баланса на достаточность (`balance >= amount + commission`).
7. При достаточном балансе: списание, запись операции, `COMMIT`.
8. При недостаточном балансе: `ROLLBACK` и сообщение об ошибке.

### 3.4 Модель конкурентного доступа (транзакции/блокировки)
**Сценарий конкуренции:**
- Клиент A и Клиент B почти одновременно снимают средства по одной карте.
- Клиент A блокирует строку счёта `SELECT ... FOR UPDATE`.
- Клиент B ждёт освобождения блокировки.
- После `COMMIT` блокировка снимается, Клиент B продолжает работу.

**Псевдокод:**
```sql
START TRANSACTION;
SELECT a.account_id, a.balance
FROM accounts a
JOIN cards c ON c.account_id = a.account_id
WHERE c.card_id = :card_id
FOR UPDATE;

-- расчёт комиссии
-- проверка баланса
UPDATE accounts SET balance = balance - :total
WHERE account_id = :account_id;

INSERT INTO withdrawals (...);
COMMIT;
```

### 3.5 Логическая и физическая модели БД
**Логическая модель:**
- banks, atms, customers, accounts, cards, withdrawals, users.

**Физическая модель:**
- таблицы определены в `schema.sql` с PK/FK, индексами;
- ограничения ссылочной целостности обеспечивают согласованность данных.

## 4. Проектирование БД

### 4.1 Таблицы, ключи и связи
1. **banks** (`bank_id` PK) — справочник банков.
2. **users** (`user_id` PK) — пользователи системы, роль `admin`/`operator`.
3. **atms** (`atm_id` PK, `bank_id` FK → banks) — банкоматы банка.
4. **customers** (`customer_id` PK, `bank_id` FK → banks) — клиенты банка.
5. **accounts** (`account_id` PK, `customer_id` FK → customers) — счета клиентов.
6. **cards** (`card_id` PK, `account_id` FK → accounts, `issuing_bank_id` FK → banks) — карты и их эмитент.
7. **withdrawals** (`withdrawal_id` PK, `atm_id` FK, `card_id` FK, `account_id` FK) — операции снятия.

### 4.2 Триггер/процедура
- **Триггер** `trg_withdrawals_calc_commission` рассчитывает комиссию и итоговое списание перед вставкой операции.
- **Процедура** `sp_withdraw_cash` демонстрирует безопасное снятие с транзакцией и блокировкой счёта.

### 4.3 Примеры SQL-запросов
**JOIN (операции с деталями):**
```sql
SELECT w.withdrawal_id, w.amount, w.commission_amount, w.total_debit, w.created_at,
       atms.location AS atm_location, atm_bank.name AS atm_bank,
       cards.pan_last4, card_bank.name AS card_bank,
       customers.full_name
FROM withdrawals w
JOIN atms ON atms.atm_id = w.atm_id
JOIN banks atm_bank ON atm_bank.bank_id = atms.bank_id
JOIN cards ON cards.card_id = w.card_id
JOIN banks card_bank ON card_bank.bank_id = cards.issuing_bank_id
JOIN accounts ON accounts.account_id = w.account_id
JOIN customers ON customers.customer_id = accounts.customer_id;
```

**GROUP BY (комиссии по банкам):**
```sql
SELECT banks.name AS bank_name, SUM(withdrawals.commission_amount) AS total_commission
FROM withdrawals
JOIN atms ON atms.atm_id = withdrawals.atm_id
JOIN banks ON banks.bank_id = atms.bank_id
GROUP BY banks.bank_id
ORDER BY total_commission DESC;
```

## 5. Реализация web-прототипа

### 5.1 Структура папок и назначение файлов
- `/` — основные страницы: `index.php`, `login.php`, `withdraw.php`, `operations.php`, `analytics.php`, CRUD-страницы справочников.
- `/includes` — общие компоненты: `init.php`, `auth.php`, `functions.php`, `header.php`, `footer.php`.
- `/ajax` — AJAX-обработчики (например, `card_info.php`).
- `/assets` — стили и клиентский JS (`style.css`, `app.js`).
- `/config` — настройки подключения к БД (`db.php`).
- `schema.sql` — структура базы и начальные данные.

### 5.2 Роли пользователей
- **Администратор (admin)**: полные права на CRUD банков, банкоматов, клиентов, карт; доступ к операциям и аналитике.
- **Оператор/аналитик (operator)**: просмотр операций, аналитика, выполнение снятия наличных; без прав на изменение справочников.

### 5.3 Ключевые страницы и функции
- `login.php` — вход, сохранение роли/логина в cookie.
- `banks.php`, `atms.php`, `customers.php`, `cards.php` — CRUD (только администратор).
- `customers.php` — отдельная форма «создать клиента + карту» (customers + accounts + cards).
- `withdraw.php` — операция снятия и расчёт комиссии.
- `operations.php` — журнал операций, фильтры и JOIN-запросы.
- `analytics.php` — агрегаты по банкам, банкоматам и датам.

### 5.4 Использование GET и POST
- **GET**: фильтрация операций в `operations.php`, запрос данных карты через `ajax/card_info.php`.
- **POST**: вход (`login.php`), CRUD справочников, создание клиента+карты (`customers.php`), снятие (`withdraw.php`).

### 5.5 Cookie и сессия 2 минуты
- Cookie используются для сохранения роли/логина после входа (`login.php`) и для сохранения фильтров операций (`operations.php`).
- Сессия автоматически завершает пользователя через 2 минуты бездействия; предупреждение появляется за 30 секунд до таймаута.

### 5.6 AJAX
AJAX применяется на странице снятия `withdraw.php`: при выборе карты отправляется запрос в `ajax/card_info.php`, ответ отображает банк-эмитент и баланс карты.

### 5.7 Серверная и клиентская валидация
- Клиентская валидация: HTML-атрибуты `required`, `pattern`, а также проверка суммы в `assets/app.js`.
- Серверная валидация: PHP-проверки на обязательные поля, корректность суммы, прав доступа и CSRF-токен.
- Клиентская проверка **не является защитой**, т.к. запросы можно подделать (например, через Postman или прямой HTTP-запрос). Поэтому критичные проверки выполняются на сервере.

### 5.8 Транзакции и блокировки
Операция снятия реализует транзакцию и блокировку счёта через `SELECT ... FOR UPDATE`, что предотвращает «гонку» при одновременных снятиях. Также предусмотрена обработка ошибок и откат при недостаточном балансе.

### 5.9 Список экранов для скриншотов
1. **Экран входа** — форма авторизации (login).
2. **Главная** — описание возможностей и текущая роль.
3. **CRUD банков** — список + форма добавления (админ).
4. **CRUD банкоматов** — список + форма добавления (админ).
5. **Клиенты** — форма создания клиента + карты.
6. **Карты** — список карт (админ).
7. **Снятие наличных** — форма + информация по карте (AJAX).
8. **Операции** — журнал с фильтрами (JOIN).
9. **Аналитика** — агрегаты комиссий, частоты и динамики.
10. **Сообщение о таймауте сессии** — предупреждение и выход.

## 6. Сценарий демонстрации (кратко)
См. отдельный раздел «Сценарий демонстрации» ниже — он покрывает все требования.

---

# Сценарий демонстрации (полный, по требованиям)

## 1. Вход и роли
1. **Требование: вход разными ролями** — войти под `admin` (логин/пароль из базы). Убедиться, что доступны CRUD-разделы.
2. **Требование: вход разными ролями** — выйти и войти под `operator`. Убедиться, что CRUD-разделы недоступны.
3. **Требование: ограничение прав** — под `operator` попытаться открыть `banks.php` и выполнить POST-добавление (получить сообщение о недостаточных правах).

## 2. CRUD (админ)
4. **Требование: CRUD (админ)** — под `admin`:
   - создать банк в `banks.php`;
   - изменить его;
   - удалить;
   - показать список (read).
5. **Требование: CRUD (админ)** — повторить для банкоматов (`atms.php`) и карт (`cards.php`).

## 3. Клиент + карта (2 таблицы)
6. **Требование: форма создания клиента + карты** — в `customers.php` открыть форму «Создать клиента + карту», заполнить поля, сохранить. Показать, что созданы записи в customers, accounts и cards (клиент и карта отображаются в списках).

## 4. Операция снятия и комиссия
7. **Требование: операция снятия** — в `withdraw.php` выбрать банкомат и карту из одного банка, снять сумму. Показать комиссию **0%**.
8. **Требование: комиссия 1.2%** — выбрать банкомат другого банка и ту же карту, снять сумму. Показать комиссию **1.2%**.
9. **Требование: обработка ошибок** — попытаться снять сумму больше баланса и показать сообщение «Недостаточно средств».

## 5. JOIN и аналитика
10. **Требование: запросы JOIN** — открыть `operations.php` и показать таблицу операций с данными из нескольких таблиц (карта, банк, клиент, банкомат).
11. **Требование: аналитические отчёты** — открыть `analytics.php` и показать агрегаты:
    - сумма комиссий по банкам;
    - частота использования банкоматов;
    - динамика операций по датам.

## 6. AJAX
12. **Требование: AJAX** — на `withdraw.php` выбрать карту и показать, что блок «Информация по карте» обновляется без перезагрузки (AJAX-запрос в `ajax/card_info.php`).

## 7. Cookie
13. **Требование: cookie** — на `operations.php` задать фильтры, обновить страницу, показать, что фильтры восстановились из cookie.
14. **Требование: cookie** — на `login.php` показать автоподстановку последнего логина (cookie `atm_last_user`).

## 8. Сессия 2 минуты
15. **Требование: 2-минутная сессия** — войти, подождать 2 минуты бездействия, показать, что сессия завершена, появляется предупреждение за ~30 секунд до истечения.

## 9. Конкурентный доступ и блокировки
16. **Требование: конкурентный доступ** — открыть два окна браузера под одним пользователем, начать две операции снятия по одной карте:
    - в первом окне подтвердить снятие;
    - во втором окне нажать «Снять» и показать, что запрос ожидает завершения первого (блокировка строки счёта).

## 10. Двойная проверка
17. **Требование: двойная проверка (клиент+сервер)** — в форме `withdraw.php` указать отрицательную сумму:
    - клиентская проверка (alert) блокирует отправку;
    - при ручной подделке запроса сервер вернёт ошибку «Сумма должна быть больше 0».

## 11. Итог
18. Подвести итог: система демонстрирует бизнес-правило комиссии, разграничение ролей, CRUD-операции, транзакции и аналитику; все требования выполнены.

---

# Заключение
В результате разработан web-прототип «Банкоматы», который реализует бизнес-правила комиссии, CRUD-операции по справочникам, операцию снятия с транзакционным контролем, а также аналитические отчёты. Решение подходит для учебной демонстрации архитектуры БД и веб-приложения с безопасной обработкой данных и конкурентного доступа.
